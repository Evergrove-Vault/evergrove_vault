# C4-нотация — подробное руководство

Кратко: C4 (Context, Containers, Components, Code) — это простая, практичная схема для документирования архитектуры ПО разработанная Саймоном Брауном. Цель — дать набор согласованных уровней абстракции и простую нотацию (прямоугольники + стрелки + ролевая информация), чтобы архитектура была понятна и разработчикам, и стейкхолдерам.

Ниже — пояснение, элементы нотации, примеры использования и практические советы.
[Подробная статья на habr](https://habr.com/ru/companies/nspk/articles/679426/)
[Подробная статья на habr](https://habr.com/ru/articles/778726/)

---

# 1. Идея и принципы

- **Четкие уровни абстракции**. Вместо одной большой диаграммы — четыре уровня детализации: Context → Containers → Components → Code. Это уменьшает шум и помогает показать нужный уровень информации нужным людям.
    
- **Простая визуальная нотация**: прямоугольники (системы/контейнеры/компоненты), люди (actors), стрелки для связей, подписи с кратким описанием коммуникации.
    
- **Документируй ради коммуникации, а не ради красивых картинок**: каждую диаграмму сопровождают подписи «какая роль у блока», «какие интерфейсы», «какие важные технологии/протоколы».
    
- **Повторяемость**. Одни и те же правила применяются ко всем диаграммам, чтобы их легко читать.
    

---

# 2. Уровни C4 и что на них показывать

## Уровень 1 — System Context (Контекст системы)

- **Цель:** показать систему в окружении — кто её использует и какие внешние системы с ней взаимодействуют.
    
- **Аудитория:** менеджеры, заказчики, новые участники команды.
    
- **Показывать:** пользовательские роли (люди/сервисы), ваша система как «чёрный ящик», внешние системы, основные потоки данных/взаимодействия.
    
- **Пример вопроса, который отвечает диаграмма:** «Кто использует систему? С какими внешними сервисами она интегрируется?»
    

## Уровень 2 — Container (Контейнеры)

- **Цель:** разбить систему на «работающие единицы» — веб-приложение, мобильное приложение, БД, фоновые сервисы, API-шлюз и т.д.
    
- **Аудитория:** разработчики, архитекторы.
    
- **Показывать:** каждый контейнер, его ответственность, технологический стек, как контейнеры общаются между собой (протоколы, порты).
    
- **Пример вопроса:** «Где выполняется бизнес-логика? Где хранятся данные? Какие отдельные процессы должны деплоиться как отдельные сервисы?»
    

## Уровень 3 — Component (Компоненты)

- **Цель:** внутри контейнера показать ключевые компоненты / модули и их API/взаимодействия.
    
- **Аудитория:** разработчики, тим-лиды.
    
- **Показывать:** компоненты с кратким описанием обязанностей, зависимости между компонентами, внешние библиотеки/интеграции, публичные интерфейсы.
    
- **Пример вопроса:** «Какие модули реализуют функциональность X? Как один модуль вызывает другой?»
    

## Уровень 4 — Code (Код / класс-диаграммы)

- **Цель:** (опционально) показать классы, интерфейсы и детали реализации внутри компонента.
    
- **Аудитория:** разработчики, ревьюверы.
    
- **Показывать:** классы, интерфейсы, основные методы и важные взаимодействия. Обычно делается для особо сложных компонентов.
    

---

# 3. Нотация — элементы и правила

- **Person / Actor (Человек)** — фигурка/иконка человека, подпись: роль + краткое описание.
    
- **System / External System (Система)** — большой прямоугольник, может быть заштрихован/другого цвета, чтобы показать, что внешний.
    
- **Container (Контейнер)** — прямоугольник внутри системы (например, «Web Application», «Mobile App», «Database»).
    
- **Component (Компонент)** — прямоугольник внутри контейнера.
    
- **Relationship (Отношение)** — стрелка между элементами. Подписывайте:
    
    - что передаётся (REST call, JSON, events),
        
    - направление,
        
    - атрибуты важные для безопасности/производительности (например, «HTTPS, OAuth2, латентность < 100ms»).
        
- **Boundary/Grouping** — рамки/контейнеры для группировки (например, «Cloud Provider A», «Внутренняя сеть»).
    
- **Три обязательных поля у сущности:** имя, тип/технология (опционально), короткое описание ответственности (1–2 строчки).
    

---

# 4. Примеры (концептуальные)

Ниже — упрощённые текстовые версии диаграмм для понимания.

**Context (пример):**

`[User: Customer] ---> (MyShop System) ---> [External Payment Service] [MyShop System] ---> [Email Provider]`

**Container (пример):**

`[Web App (React)] ---> [API Server (Node.js)] [API Server] ---> [Auth Service (OAuth)] [API Server] ---> [Database (Postgres)] [Background Worker] ---> [Message Queue (RabbitMQ)] ---> [API Server]`

**Component (внутри API Server):**

`[API Server]   ├─ [Auth Component] <-- calls --> [User Repository]   ├─ [Order Component] <-- publishes --> [Payment Integration]   └─ [Reporting Component]`

---

# 5. Практические советы и лучшие практики

- **Одна диаграмма — одна цель.** Не пытайтесь показать всё сразу. Создавайте отдельные диаграммы для разных заинтересованных лиц.
    
- **Подписи к стрелкам — обязательны.** Укажите формат/протокол и направление.
    
- **Не перегружайте компонентную диаграмму.** Покажите только ключевые компоненты, а мелкие вспомогательные — по желанию.
    
- **Используйте легенду и уровни (L1, L2, L3)**, чтобы люди понимали, какой уровень смотрят.
    
- **Версионирование и место хранения.** Храните диаграммы вместе с кодом/репозиторием в удобном формате (структурированный DSL) и документируйте, кто их поддерживает.
    
- **Автоматизируйте построение, где это возможно.** Например, интегрируйте генерацию диаграмм в CI, чтобы архитектура не «отставала» от кода.
    
- **Согласуйте терминологию.** Убедитесь, что «контейнер», «сервис», «модуль» используются одинаково в команде.
    

---

# 6. Инструменты (кратко)

(перечисляю популярные варианты — ориентируйтесь на то, что удобнее в вашей команде)

- **Structurizr** — платформа от автора C4, поддерживает DSL и визуализацию (хороша для хранения и версионирования).
    
- **PlantUML + C4-PlantUML** — позволяет генерировать диаграммы через текстовые файлы; удобно в репозитории.
    
- **Diagrams.net (draw.io)** — ручной рисовальщик, прост для быстрых диаграмм.
    
- **Lucidchart, Miro, Mermaid** и др. — в зависимости от предпочтений команды.
    

---

# 7. Примеры PlantUML (шаблоны)

Ниже — упрощённые примеры синтаксиса для C4-PlantUML. (Чтобы рендерить, нужно подключить библиотеку C4-PlantUML в PlantUML.)

**Context (PlantUML + C4):**

`@startuml !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml  Person(customer, "Customer", "конечный пользователь") System(myshop, "MyShop", "Онлайн-магазин") System_Ext(payment, "Payment Gateway", "Внешний платежный провайдер")  Rel(customer, myshop, "Покупает товары") Rel(myshop, payment, "Запрос на оплату (HTTPS/JSON)") @enduml`

**Container:**

`@startuml !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml  Person(customer, "Customer") System_Boundary(myshop, "MyShop System") {   Container(web, "Web App", "React")   Container(api, "API", "Node.js/Express")   Container(db, "Database", "Postgres") } Rel(customer, web, "Использует") Rel(web, api, "REST API") Rel(api, db, "SQL") @enduml`

(Примечание: ссылки на `!include` нужны для C4-PlantUML; если у вас оффлайн-окружение — подключите библиотеку локально.)

---

# 8. Частые ошибки

- **Смешивание уровней** — попытка показать Context и Component на одной диаграмме создаёт путаницу.
    
- **Избыточная детализация стрелок** — лишние подписи делают диаграмму громоздкой; оставляйте только важное.
    
- **Нет объяснения «почему»** — диаграмма должна сопровождаться кратким текстом с целями и ограничениями архитектуры.
    
- **Диаграммы устарели** — фиксируйте владельца и процесс обновления.
    

---

# 9. Когда C4 НЕ подходит

- Если вам нужно строго формальное моделирование (полная семантика, формальные проверки) — возможно, лучше UML или формальные спецификации.
    
- Для очень мелких скриптов/проектов с одной-двумя файлами C4 может быть избыточен.
    

---

# 10. Резюме (быстро)

- C4 = набор простых, понятных диаграмм на 4 уровнях: Context → Container → Component → Code.
    
- Стремитесь к ясности: кто, что, где, как и почему.
    
- Подписывайте стрелки, храните диаграммы в репозитории, автоматизируйте где можно.
    
- Используйте Structurizr/PlantUML/другие инструменты для удобного поддержания диаграмм.